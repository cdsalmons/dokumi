About build scripts
===================

Make sure you first read the paragraph of README.md about build scripts.

All paths returned by Dokumi are instances of Pathname.

A build script will be executed with the current working directory being the directory where the repository has been cloned into.

Environment of build scripts
----------------------------

In a build script, `self` is an instance of BuildEnvironment meaning you have access to:
- `action`: `:review` or `:archive` depending on the command used to run Dokumi.
- `work_directory`: If you need a directory to work in, you can use `work_directory`. `work_directory` is recreated at every build and is located at `work/host/owner/repo`.
- `source_directory`: The directory the source has been cloned into (also the current directory when the script starts running). It is cleaned with `git clean` and reset before every build.
- `issues`: Problems found in the code that is being reviewed. To report an issue you need to use `add_issue`. Issues can be of 3 types: `:error`, `:static_analysis`, `:warning`. Ignored in review mode.
- `artifacts`: Artifacts generated by the build.
- `add_issue(new_issue)`: Report a problem found in the code that is being reviewed. Duplicates are ignored. Note that warnings that are not around code that has been modified by the pull request will be filtered out before commenting on the pull request.
- `add_artifacts(artifact1, artifact2, ...)`: Report that an artifact was generated.
- `error_found?`: Has any error found in the code being reviewed?
- `action_executed?`: Has any meaningful action been executed? Used to make sure a script did something.
- `options`: Options given to Dokumi on the command line. For example, if Dokumi is run using `bundle exec bin/archive --build_type=test`, `options[:build_type]` will return `"test"`. If needed, depending on how Dokumi was run, it may contain for example `:branch`, `:tag`, `:pull_request`.

All of this is nice to have, but how do you make Dokumi review your code? For that, in addition to the methods above, you have access to tools. Dokumi has currently 2 tools available by default: `xcode` and `android`.

The xcode tool
--------------

In a script file, via `xcode` you can access to the Xcode-related features, for example use `xcode.install_pods` to run `pod install` in the current directory.

All the compiler warnings, static analysis warnings, errors found are automatically added to the issues of the build environment.

The main features available are the following:

- `use_xcode_version(version)`: To specify the version of Xcode to use for the current build. `version` must be a version included in `xcode_version.yml`. By default, Dokumi uses the version specified as "default" in `xcode_version.yml`.
- `modify_project(xcodeproj_path)`: To rewrite part of an Xcode project. You must give it a block that will be called with an instance of ProjectHelper allowing to make modifications to a project.
- `icon_paths_in_project(xcodeproj_path)`: Returns a list of the paths of the icons included in a project.
- `analyze(project_path, options)`: To perform a static analysis of the project, like Xcode's Analyze command. You must specify the Scheme to build with the `:scheme` option.
- `test(project_path, options)`: To run the application's automatic tests, like Xcode's Test command. You must specify the Scheme to build with the `:scheme` option, and the Simulator destination with the `:destination` option. You can specify just one destination `"platform=iOS Simulator,OS=8.4,name=iPhone 4s"` or multiple `["platform=iOS Simulator,OS=8.4,name=iPhone 4s", "platform=iOS Simulator,OS=8.4,name=iPhone 6"]` if you want. Running tests in the simulator for an old iPhone like the iPhone 4s, and in the simulator for a recent iPhone like the iPhone 6 makes sure your tests run in both 32 and 64-bit.
- `archive(project_path, options)`: To build an archive (IPA file) of the project, like Xcode's Archive command. You must specify the Scheme to build with the `:scheme` option.
- `install_pods`: To run `pod install` in the current directory. It will guess what version of CocoaPods to run, either by using bundler if a `Gemfile` file is present, or by looking at the version written in `Podfile.lock`
- `find_unchanged_storyboards`: Look if the pull request contains any Storyboard or XIB file that has been modified but the only modification is the Xcode version used to write the file.
- `find_misplaced_constraints`: Look if the pull request contains any Storyboard or XIB file that has misplaced constraints.

Tools
------

Tools are automatically loaded by the build environment from lib/dokumi/tool/*.rb and from custom/tool/*.rb, and are made automatically available in the build environment under their file name (`my_tool.rb` is available as `my_tool`).

`lib/dokumi/tool` contains the Dokumi internal tools, tools that would be useful to most people. `custom/tool` is for your custom tools.

The class name of a tool must be the camel case version of the file name (Dokumi will expect to find a `MyTool` class inside `my_tool.rb`). That class must be in the `Dokumi::Tool` module if the tool is in `lib/dokumi/tool`, and in the `Dokumi::Custom::Tool` module if the tool is in `custom/tool`.

The first time the user accesses `my_tool`, Dokumi will create an instance of the MyTool class, giving its constructor the build environment as a parameter. By using it, a tool can access all the features a build script has access to.
